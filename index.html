<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radiographer Reject Rate Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7f9;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
        }
        h1 {
            margin: 0;
        }
        .input-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        input, button {
            padding: 10px 15px;
            margin: 0 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .data-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .data-card {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .month-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .month-tab {
            padding: 10px 20px;
            background-color: #e0e0e0;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .month-tab.active {
            background-color: #3498db;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .no-data {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        .trend-chart-container {
            position: relative;
            height: 400px;
        }
        .chart-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        .trend-indicator {
            font-size: 14px;
            margin-top: 5px;
        }
        .trend-up {
            color: #e74c3c;
        }
        .trend-down {
            color: #27ae60;
        }
        .trend-stable {
            color: #f39c12;
        }
    </style>
</head>
<body>
    <header>
        <h1>Radiographer Reject Rate Analysis</h1>
        <p>Analyze image reject rates and trends by radiographer</p>
    </header>

    <div class="input-section">
        <h2>Enter Radiographer Initials</h2>
        <input type="text" id="techIdInput" placeholder="e.g., AAJ" maxlength="3">
        <button id="fetchDataBtn">Fetch Data</button>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="loadingIndicator" class="loading" style="display: none;">
        <p>Loading data...</p>
    </div>

    <div id="resultsContainer" style="display: none;">
        <div class="chart-container">
            <h2>Reject Rate Trend</h2>
            <div class="trend-chart-container">
                <canvas id="trendChart"></canvas>
            </div>
            <div class="chart-stats" id="trendStats">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <div class="month-tabs" id="monthTabs">
            <!-- Month tabs will be generated here -->
        </div>

        <div class="data-section">
            <div class="data-card">
                <h2 id="bodyPartTitle">Body Parts Imaged</h2>
                <canvas id="bodyPartChart"></canvas>
            </div>
            
            <div class="data-card">
                <h2 id="rejectRateTitle">Reject Rate by Body Part</h2>
                <canvas id="rejectRateChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2 id="rejectReasonTitle">Reject Reasons by Body Part</h2>
            <div id="rejectReasonTable"></div>
        </div>
    </div>

    <script>
        // Global variables
        let mayData = [];
        let juneData = [];
        let currentMonth = '2025-05'; // Default to May
        
        // DOM elements
        const techIdInput = document.getElementById('techIdInput');
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContainer = document.getElementById('resultsContainer');
        const monthTabs = document.getElementById('monthTabs');
        const bodyPartTitle = document.getElementById('bodyPartTitle');
        const rejectRateTitle = document.getElementById('rejectRateTitle');
        const rejectReasonTitle = document.getElementById('rejectReasonTitle');
        const trendStats = document.getElementById('trendStats');
        
        // Chart instances
        let trendChart = null;
        let bodyPartChart = null;
        let rejectRateChart = null;

        // Event listeners
        fetchDataBtn.addEventListener('click', fetchData);
        
        // Function to fetch data
        async function fetchData() {
            const techId = techIdInput.value.trim().toUpperCase();
            
            if (!techId) {
                showError("Please enter a radiographer ID");
                return;
            }
            
            // Reset previous data
            hideError();
            showLoading();
            hideResults();
            
            try {
                // Fetch both months data
                const [mayResponse, juneResponse] = await Promise.all([
                    fetch('15. MB Fuji R1 DR 2025-05.json'),
                    fetch('15. MB Fuji R1 DR 2025-06.json')
                ]);
                
                if (!mayResponse.ok || !juneResponse.ok) {
                    throw new Error('Failed to fetch data files');
                }
                
                mayData = await mayResponse.json();
                juneData = await juneResponse.json();
                
                // Filter data for the specific tech ID
                const mayTechData = mayData.filter(item => item['Tech ID'] === techId);
                const juneTechData = juneData.filter(item => item['Tech ID'] === techId);
                
                if (mayTechData.length === 0 && juneTechData.length === 0) {
                    throw new Error(`No data found for radiographer ${techId}`);
                }
                
                // Process and display data
                processAndDisplayData(techId, mayTechData, juneTechData);
                
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Process data and create visualizations
        function processAndDisplayData(techId, mayData, juneData) {
            // Calculate monthly reject rates
            const mayRejectRate = calculateRejectRate(mayData);
            const juneRejectRate = calculateRejectRate(juneData);
            
            // Create trend chart
            createTrendChart(mayRejectRate, juneRejectRate, mayData.length, juneData.length);
            
            // Create month tabs
            createMonthTabs();
            
            // Display data for the default month (May)
            displayMonthData('2025-05', mayData);
            
            // Show results container
            resultsContainer.style.display = 'block';
        }
        
        // Calculate reject rate for a dataset
        function calculateRejectRate(data) {
            if (data.length === 0) return 0;
            
            const totalImages = data.length;
            const rejectedImages = data.filter(item => item['Reject Category'] && item['Reject Category'].trim() !== '').length;
            
            return (rejectedImages / totalImages) * 100;
        }
        
        // Create enhanced trend chart with line + bar combination
        function createTrendChart(mayRate, juneRate, mayTotal, juneTotal) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            // Calculate dynamic scale
            const maxRate = Math.max(mayRate, juneRate);
            const yAxisMax = maxRate === 0 ? 10 : Math.ceil(maxRate * 1.2);
            
            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['May 2025', 'June 2025'],
                    datasets: [
                        {
                            label: 'Reject Rate (%)',
                            type: 'bar',
                            data: [mayRate, juneRate],
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.6)',
                                'rgba(155, 89, 182, 0.6)'
                            ],
                            borderColor: [
                                'rgba(52, 152, 219, 1)',
                                'rgba(155, 89, 182, 1)'
                            ],
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        },
                        {
                            label: 'Trend Line',
                            type: 'line',
                            data: [mayRate, juneRate],
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(231, 76, 60, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            tension: 0.2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const total = index === 0 ? mayTotal : juneTotal;
                                    return `Total Images: ${total}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,
                            title: {
                                display: true,
                                text: 'Reject Rate (%)',
                                color: '#333',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                color: '#333',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            // Update trend statistics
            updateTrendStats(mayRate, juneRate, mayTotal, juneTotal);
        }
        
        // Update trend statistics display
        function updateTrendStats(mayRate, juneRate, mayTotal, juneTotal) {
            const rateDifference = juneRate - mayRate;
            const averageRate = (mayRate + juneRate) / 2;
            
            let trendClass = 'trend-stable';
            let trendSymbol = '→';
            let trendText = 'Stable';
            
            if (rateDifference > 0.5) {
                trendClass = 'trend-up';
                trendSymbol = '↗';
                trendText = 'Increasing';
            } else if (rateDifference < -0.5) {
                trendClass = 'trend-down';
                trendSymbol = '↘';
                trendText = 'Decreasing';
            }
            
            trendStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${mayRate.toFixed(1)}%</div>
                    <div class="stat-label">May Rate</div>
                    <div class="stat-label">(${mayTotal} images)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${juneRate.toFixed(1)}%</div>
                    <div class="stat-label">June Rate</div>
                    <div class="stat-label">(${juneTotal} images)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${averageRate.toFixed(1)}%</div>
                    <div class="stat-label">Average</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value ${trendClass}">${Math.abs(rateDifference).toFixed(1)}%</div>
                    <div class="stat-label">Change</div>
                    <div class="trend-indicator ${trendClass}">${trendSymbol} ${trendText}</div>
                </div>
            `;
        }
        
        // Create month tabs
        function createMonthTabs() {
            monthTabs.innerHTML = '';
            
            const months = [
                { id: '2025-05', name: 'May 2025' },
                { id: '2025-06', name: 'June 2025' }
            ];
            
            months.forEach(month => {
                const tab = document.createElement('div');
                tab.className = `month-tab ${month.id === currentMonth ? 'active' : ''}`;
                tab.textContent = month.name;
                tab.addEventListener('click', () => {
                    // Update active tab
                    document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update data display
                    currentMonth = month.id;
                    displayMonthData(month.id, month.id === '2025-05' ? mayData : juneData);
                });
                
                monthTabs.appendChild(tab);
            });
        }
        
        // Display data for a specific month
        function displayMonthData(monthId, data) {
            const techId = techIdInput.value.trim().toUpperCase();
            const monthData = data.filter(item => item['Tech ID'] === techId);
            
            // Update titles with month
            bodyPartTitle.textContent = `Body Parts Imaged - ${monthId === '2025-05' ? 'May 2025' : 'June 2025'}`;
            rejectRateTitle.textContent = `Reject Rate by Body Part - ${monthId === '2025-05' ? 'May 2025' : 'June 2025'}`;
            rejectReasonTitle.textContent = `Reject Reasons by Body Part - ${monthId === '2025-05' ? 'May 2025' : 'June 2025'}`;
            
            if (monthData.length === 0) {
                document.getElementById('bodyPartChart').style.display = 'none';
                document.getElementById('rejectRateChart').style.display = 'none';
                document.getElementById('rejectReasonTable').innerHTML = '<div class="no-data">No data available for this month</div>';
                return;
            }
            
            document.getElementById('bodyPartChart').style.display = 'block';
            document.getElementById('rejectRateChart').style.display = 'block';
            
            // Create body part chart
            createBodyPartChart(monthData);
            
            // Create reject rate chart
            createRejectRateChart(monthData);
            
            // Create reject reason table
            createRejectReasonTable(monthData);
        }
        
        // Create body part chart (regions imaged)
        function createBodyPartChart(data) {
            const bodyPartCounts = {};
            
            data.forEach(item => {
                const bodyPart = item['Body Part'];
                bodyPartCounts[bodyPart] = (bodyPartCounts[bodyPart] || 0) + 1;
            });
            
            // Sort by count descending
            const sortedBodyParts = Object.entries(bodyPartCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 only
            
            const ctx = document.getElementById('bodyPartChart').getContext('2d');
            
            if (bodyPartChart) {
                bodyPartChart.destroy();
            }
            
            bodyPartChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedBodyParts.map(item => item[0]),
                    datasets: [{
                        label: 'Number of Images',
                        data: sortedBodyParts.map(item => item[1]),
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y', // Horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Images'
                            }
                        }
                    }
                }
            });
        }
        
        // Create reject rate by body part chart
        function createRejectRateChart(data) {
            const bodyPartStats = {};
            
            // Initialize counts for each body part
            data.forEach(item => {
                const bodyPart = item['Body Part'];
                if (!bodyPartStats[bodyPart]) {
                    bodyPartStats[bodyPart] = { total: 0, rejected: 0 };
                }
                
                bodyPartStats[bodyPart].total += 1;
                if (item['Reject Category'] && item['Reject Category'].trim() !== '') {
                    bodyPartStats[bodyPart].rejected += 1;
                }
            });
            
            // Calculate reject rates and prepare data for chart
            const bodyPartRates = [];
            for (const [bodyPart, stats] of Object.entries(bodyPartStats)) {
                const rejectRate = stats.total > 0 ? (stats.rejected / stats.total) * 100 : 0;
                bodyPartRates.push({ bodyPart, rejectRate, total: stats.total });
            }
            
            // Sort by reject rate descending and take top 10
            const topBodyParts = bodyPartRates
                .sort((a, b) => b.rejectRate - a.rejectRate)
                .slice(0, 10);
            
            const ctx = document.getElementById('rejectRateChart').getContext('2d');
            
            if (rejectRateChart) {
                rejectRateChart.destroy();
            }
            
            rejectRateChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topBodyParts.map(item => item.bodyPart),
                    datasets: [{
                        label: 'Reject Rate (%)',
                        data: topBodyParts.map(item => item.rejectRate),
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Reject Rate (%)'
                            }
                        }
                    }
                }
            });
        }
        
        // Create reject reason table
        function createRejectReasonTable(data) {
            const bodyPartReasons = {};
            
            // Organize data by body part and reject reason
            data.forEach(item => {
                const bodyPart = item['Body Part'];
                const rejectCategory = item['Reject Category'] || 'Not Rejected';
                
                if (!bodyPartReasons[bodyPart]) {
                    bodyPartReasons[bodyPart] = {};
                }
                
                bodyPartReasons[bodyPart][rejectCategory] = (bodyPartReasons[bodyPart][rejectCategory] || 0) + 1;
            });
            
            // Create HTML table
            let tableHTML = '<table>';
            tableHTML += '<thead><tr><th>Body Part</th><th>Reject Reason</th><th>Count</th><th>Percentage</th></tr></thead>';
            tableHTML += '<tbody>';
            
            for (const [bodyPart, reasons] of Object.entries(bodyPartReasons)) {
                const totalForBodyPart = Object.values(reasons).reduce((sum, count) => sum + count, 0);
                let firstRow = true;
                
                for (const [reason, count] of Object.entries(reasons)) {
                    const percentage = ((count / totalForBodyPart) * 100).toFixed(1);
                    
                    tableHTML += `<tr>`;
                    if (firstRow) {
                        tableHTML += `<td rowspan="${Object.keys(reasons).length}">${bodyPart}</td>`;
                        firstRow = false;
                    }
                    tableHTML += `<td>${reason}</td>`;
                    tableHTML += `<td>${count}</td>`;
                    tableHTML += `<td>${percentage}%</td>`;
                    tableHTML += `</tr>`;
                }
            }
            
            tableHTML += '</tbody></table>';
            document.getElementById('rejectReasonTable').innerHTML = tableHTML;
        }
        
        // Utility functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        function showLoading() {
            loadingIndicator.style.display = 'block';
        }
        
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }
        
        function hideResults() {
            resultsContainer.style.display = 'none';
        }
    </script>
</body>
</html>
